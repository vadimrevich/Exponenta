
[[17.05.2018]]

[6:35:36]

Вкратце расскажу о ресурсах, используемых при установке троянца.

Основной каталог троянца -- каталог C:\pub1, который ассоциирован с переменной окружения %PUB1% Дополнительно в систему устанавливаются пакеты Elevation в каталог C:\Elevation (переменнная %ELEVATION%), пакет "Hidden Start" в каталоге "C:\Program Files\Hidden Start" (без установленной переменной, но с регистрацией в реестре) и пакет Chocolatey, который инсталлируется в командной строке по адресу: C:\ProgramData\chocolatey, его данные автоматически прописываются в реестр и автозагрузку. Каталоги %PUB1% и %ELEVATION% являются скрытыми. Через менеджер пакетов chocolatey устанавливается программа Sysinternals, используемая в Elevation.

[Проверяемые данные]

Вначале проверяется его установка:

-- Существование каталогов c:\pub1, C:\Elevation, "C:\Program Files\Hidden Start", C:\ProgramData\chocolatey
-- Существование переменных в реестре: %PUB1%, %ELEVATION%, %Hacker_User%, %Hacker_Pass%, %Hacker_host1%, %Hacker_host2%,
-- Существует ли запись в реестре для пакета "Hidden Start".
-- Существует ли учётная запись MyAdminAccount
-- Существует ли запись "Onload Command Interface" в ветви реестра "HKLM\SOFTWERE\WOW6432Node\Microsoft\Windows\Current\Version\Run"

Если данные ресурсы существуют, они удаляются, кроме пакета chocolatey. Это основа работы деинсталлятора.

При установке троянца также устанавливаются службы WinRM и Telnet Server, которые не удаляются деинсталлятором, а приводятся их значения к стандартным параметрам. При этом предусмотрена обработка ошибок повторной инсталляции сервисов и смены несуществующих значений.

В принципе, перед повторной установкой пакета всегда запускается деинсталлятор, с указанными выше допущениями. Это сделано для того, чтобы хакер всегда имел незапорченную стандартную систему для исполнения функций ботнета.

[10:30:38]

Скрипт проверки существования учётной записи.

check_uname_present.bat

Скрипт проверки учётной записи на наличие прав администратора

check_uname_admin.bat

Скрипт проверки существования записи в реестре

check_reg_item.bat

Скрипт проверки существования куста реестра

check_reg_node.bat

Тексты этих скриптов будут приведены на GitHab'е

[13:06:08]

[Хак для проверки значений реестра, передаваемых через параметры]

Для проверки существования веток реестра удобно использовать команду reg query, которая выдаёт информацию об имеющихся кустах и переменных реестра. К сожалению, у этой команды есть недостатки:

1. Данная команда всегда возвращает код ошибки 0б даже если она ничего не нашла.
2. При присвоении параметрам этой команды стандартных параметров командных файлов %номер поведение программы не предсказуемо из-за возможного переопределения области видимости переменной в командном файле (эка как мудрёно).

Для обхода первого ограничения необходим хак, который проверяет в контейнере вывода стандартных сообщений об ошибках программы типа   "Ошибка. Неверный синтаксис" и "Ошибка: Не удается найти указанный раздел или параметр в реестре.". Если эти сообщения появляются, то происходит выдача сообщения об отсутствии ключа или звена в реестре. Этот хак достаточно условный. Во-первых, он работает только с русскими версиями Windows. Во-вторых, он пропускает прочие сообщения об ошибках в этой программе, например, доступ к реестру запрещён. Так что этой программой можно проверить только гарантированное отсутствие ключа в реестре. В третьих, ложное срабатывание -- если в значении параметра встречаются указанные строки.

Для обхода второго недостатка, присущему, кстати, всем командам reg, можно использовать, напримет, следующий хак:

set node=%1
reg query "!node!" /ve

В первой строчке мы присваиваем переменной node значение первого параметра командного файла. Во второй строке мы используем разименованное значение переменной %node% для обозначения куста реестра (который был передан командному файлу первым параметром).

Только с помощью этих двух хаков удалось проверить наличие кустов и переменных в реестре Windows.

[13:28:08]

Скрипт для добавления значения значений экспортированного куста реестра

reg_import_file.bat

Скрипт для экспорта резервной копии куста реестра

reg_export_reserve.bat

Скрипт для удаления куста реестра Windows:

reg_del_node.bat

Скрипт для удаления постоянной переменной из окружения Windows

reg_del_envvar.bat

Скрипт для запуска приложения или командного файла от имени администратора 

RanAsAdminHere.cmd

Запуск окружения администратора в текущем каталоге

CmdAsAdminHere.cmd

Запуск системного окружения в текущем каталоге

CmdAsSystemHere.cmd


